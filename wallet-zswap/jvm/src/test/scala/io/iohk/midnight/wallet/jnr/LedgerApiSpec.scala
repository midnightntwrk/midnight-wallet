package io.iohk.midnight.wallet.jnr

import io.iohk.midnight.wallet.jnr.Ledger.{TxAppliedSuccessfully, TxApplyError}
import munit.ScalaCheckSuite

import scala.util.{Failure, Success, Try}

class LedgerApiSpec extends ScalaCheckSuite {

  private val validTx =
    "000000000000000000000000000000000001010000000101000000040000007472656506020a000000000000000001000000000200000005000000636865636b010020000000000000d8730ff06ab78590903b60e16d00fe68104428a5b362532cda47ed205c05c800c48d727e9a75201bcee5a0cad8501d0185edde0a8340896ac3f95cf841042964c77c132c400e737ebc9c61dd310ef0f28227e700f4ce1be46a0dcf221bdbdc0c21110b753465afc4c3a6079ab511177f69e7390a5cb73afef120612c0f6bdaf61e853b2c23ceea3f57b201e4bad3488eb5e791a951771fcdc65988b52624f00aaa67eeadf8bb80af64166d5bf840352f76a42cd7c3b13c8c1da3a336110aff0205a8664432bd2d7f0f122b3737196973236588a8fede7f6813553beeda9ba02b4a5c8c2753cabdc7740cb9b516516a04f43783034bc15e5bed313fb60b73f66a3e8bfeb92e4b3e112c7a8f8e80672fa860b11065ca0fa26b7bcd8f341332c90e423cda7a42600f20da83437982b9250467407bdd24c5dfd9de4e53f82e77d4c60038acf97bcbb370de03c7b7a799fe8d15b3e75ec5841cfa9ef7e3bea066e43712c7ac49bc7a3e0f1d279e4c83bed9e678f64cb331f66071c53d5bcdd6e102090000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000407180f8f19902563f2ac7f1e27155729adacaf1f7015750ffca71e13937fe9e7b06f90810bf5b58945c1901a42e8591047d197f936dfc19812c4af3bb72acdabc371800b445f7443f2abbff794c38993fa22beea803bf9fa84dcd1bfac108441876466991547c736afaef9b11ccf00e25dd6834192ff64ae711ff37b9d5ab7894be42013496bfd49a133622d1d3ea698fe497aa2769666f4028dd71557dc40e82006ce856d9d2945a18a12013d391f7a5951df4062cd788aa4b8d559de0677c01000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000040050000000000000004000000000000000500000000000000a913000000000000aa13000000000000ab1300000000000001000000160400000074726565000000000500000073746f72650100020000000000005d3d829c0b8c6058e9d8096223e280ebab4cdfaa8926d3746f3da7db72f783e33734dbb61bedc9b7176b771efbe480820d2e1bd099a530c58815ad640fa61d69d5eb85459aa41c1c6ec0db90d0fe2bca7884131cadfcf567d8ce38e4cd65b406e43ce80fedc247e7d7ea1163d3e18a023f31a408b37d694b2ffc40906c501e12590da33dd3c0b08fbb6163f4b19dce0bebfab24d1e24d5be3e6a120d52c26d01ff9adfd05911c8fa3d5b80da81e056b6c991844a904f8df484a2bd5a1b140f0cde48efe987d263ae7edd77dcc9d2ba3c9fbbf934086053c5f11a6abf1f06189cdc06d51f0172d188f375669b44e0d60c9c935a25161bbd6dd94cc5e48390f22e68b09adc6101ecd82b5eaf2051c143e22dce86438e1e38d0fb9bc0a9f1ce9106570c6c162f4ebb7936d7a7aef8f59e809481b6ff7e549f06cd3acd8efcbf33747d6ca8d4327b68c8e107759949ac6406d769bc1a511f26e4d333912b9039ec1245e70b293f5912dca5115dec95167d58d31e2ec29c9102c70ae4247cd7f2fe15000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000040548430f81421d7b8cd4a1487cec7437474dee55d9dd5a730b53c572cc9d80b54b120ff6c7d98f536139f531d67ea5b14822e2f2928054be07d5379c5ed4c0ea89eb751a93e309aea72f5b4ac0da649fec85e097ca0ae3eb2fe988fd1d0bead82c1d56192a2bde38d088b30f81cf1f06280c1e580f956180b901bbd361aeceda3476a0fb073677376090173e20c4fc700977c8bd463aa112027ce6e61269c0fbbd4b070bfabbcc65547edb33acf88a73206bd689a6e57db18fcbb3b4d9083c48d00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004004000000000000000400000000000000050000000000000015000000000000001600000000000000010000000a04000000747265650100000000010c00000000000000580e74412a89ab4675d0f7dd92e698496e010cc8bec56156f29ec5de9f622abd0c9d2e7d8fee9f0a8438bc51dc2ba70e6a880b2227fa480c1985c83a80148ec439865b3216b0cd37868ab16aff60489db3a446a14a911af6ae37cf60ec86435b2046d53c3317a06743869dd867c5c6016298f916993f9757d2b6eab41734b9540e205dd4009b513889f3e741161a62267fbef71e9396d2b6fd7c8259fa2133bfe006"

  private val hexedEncryptionSecretKey =
    "20d70aa9e64eae18b2d0e374b98f429fd3ffc816b0e479606c5ad9e362ea971c0c"

  private val localState =
    "8fb627bc6b525a05e3418eccf90c4e5dcf5269b8574232ad2adbea18f0d558871fb275660bea21a25eea73cbcb2e2b0a58b23fab5ceda0e798bd824bda93dcd300000000000000000000000002200000000000000000"

  private val ledger = LedgerLoader.loadLedger.getOrElse(fail("Invalid ledger state"))

  test("Checking relevance without correct encryption key should give proper error") {
    Try(ledger.isTransactionRelevant(validTx, "invalid_secret_key")) match {
      case Failure(exception) => fail(exception.getMessage)
      case Success(result)    => assertEquals(result, LedgerError.EncryptionSecretKeyError)
    }
  }

  test("Checking relevance without correct tx should give proper error") {
    Try(
      ledger.isTransactionRelevant("invalid_tx", hexedEncryptionSecretKey),
    ) match {
      case Failure(exception) => fail(exception.getMessage)
      case Success(result)    => assertEquals(result, LedgerError.TransactionError)
    }
  }

  test("Applying tx to state should succeed") {
    ledger.applyTransactionToState(validTx, localState) match {
      case Right(_: TxAppliedSuccessfully) => assert(true)
      case Left(error)                     => fail(error.getMessage)
      case Right(_: TxApplyError)          => fail("Wrong case.")
    }
  }

  test("Applying tx without correct tx should give proper error") {
    ledger.applyTransactionToState("invalid_tx", localState) match {
      case Right(TxApplyError(ledgerError, _)) =>
        assertEquals(ledgerError, LedgerError.TransactionError)
      case Left(error) =>
        fail(error.getMessage)
      case Right(_: TxAppliedSuccessfully) => fail("Wrong case.")
    }
  }

  test("Applying tx without correct state should give proper error") {
    ledger.applyTransactionToState(validTx, "invalid_state") match {
      case Right(TxApplyError(ledgerError, _)) =>
        assertEquals(ledgerError, LedgerError.StateError)
      case Left(error) =>
        fail(error.getMessage)
      case Right(_: TxAppliedSuccessfully) => fail("Wrong case.")
    }
  }
}
