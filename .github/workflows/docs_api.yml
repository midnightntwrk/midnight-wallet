name: Publish updated API documentation
env:
  MIDNIGHTBOT_PACKAGES_WRITE: ${{ secrets.MIDNIGHTBOT_PACKAGES_WRITE }}
on:
  push:
    branches:
      - main
    paths:
      - 'typescript/packages/dapp-connector-api/**'
  workflow_dispatch:

jobs:
  docs:
    runs-on: ubuntu-latest
    steps:
      - name: Prepare .netrc to access other repos
        run: echo -e "machine github.com\nlogin git\npassword ${{ secrets.GH_TOKEN }}\n\nmachine api.github.com\nlogin git\npassword ${{ secrets.GH_TOKEN }}" > ~/.netrc && chmod 755 ~/.netrc
      - uses: actions/checkout@v3
      - uses: nixbuild/nix-quick-install-action@v25
        with:
          github_access_token: ${{ secrets.GH_TOKEN }}
          nix_conf: |
            access-tokens = github.com=${{ secrets.GH_TOKEN }} api.github.com=${{ secrets.GH_TOKEN }}
            extra-trusted-public-keys = hydra.iohk.io:f/Ea+s+dFdN+3Y/G+FDgSq+a5NEWhJGzdjvKNGv0/EQ=
            extra-substituters = https://cache.iog.io
            accept-flake-config = true
            netrc-file = ~/.netrc
      - name: Restore and cache Nix store
        uses: nix-community/cache-nix-action@v4
        with:
          gc-linux: true
          gc-max-store-size-linux: 8000000000
          key: cache-ubuntu-${{ hashFiles('**/*') }}
          restore-keys: |
            cache-ubuntu-
      - name: Setup .npmrc
        run: |
          echo "
          //npm.pkg.github.com/:_authToken=$MIDNIGHTBOT_PACKAGES_WRITE
          " >> ./.npmrc
      - name: Configure yarn
        run: |
          cd typescript
          yarn config set 'npmScopes.midnight-ntwrk.npmAuthToken' "$MIDNIGHTBOT_PACKAGES_WRITE"
          echo 'enableImmutableInstalls: false' >> ./.yarnrc.yml
      - name: Run yarn install
        run: nix develop .#typescript --command yarn
      - name: Generate documentation
        run: nix develop .#typescript --command yarn run build:docs
      - name: Check if there are changes in docs and create a new branch
        id: set_update
        run: |
          if git diff-index HEAD -- typescript/packages/dapp-connector-api/; then
            echo "Adding new..."
            git config --global user.email "midnight-ci@users.noreply.github.com"
            git config --global user.name "Midnight CI GitHub Action"
            BRANCH=api-docs/merge-prs/`date +'%Y-%m-%dT%H%M%S'`
            git checkout -b $BRANCH
            git push -u origin $BRANCH
            echo "UPDATE=true" >> $GITHUB_OUTPUT
            echo "NEW_BRANCH=$BRANCH" >> $GITHUB_OUTPUT
          else
            echo "Nothing to update"
            echo "UPDATE=false" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
      - uses: MonikaJassova/ghcommit-action@aee0efc02d3707e178c534477e5c87f70fe6678f
        if: steps.set_update.outputs.UPDATE == 'true'
        with:
          commit_message: "DApp Connector API documentation update - created by Midnight CI Github Action"
          repo: ${{ github.repository }}
          branch: ${{ steps.set_update.outputs.NEW_BRANCH }}
          file_pattern: 'typescript/packages/dapp-connector-api/docs'
        env:
          GITHUB_TOKEN: ${{secrets.GH_TOKEN}}
      - name: Open a PR
        if: steps.set_update.outputs.UPDATE == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
        run: gh pr create --base main --head ${{ steps.set_update.outputs.NEW_BRANCH }} --title "API documentation update" --body "Update API documentation - created by Midnight CI Github Action"
