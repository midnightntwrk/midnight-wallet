name: Publish updated API documentation

env:
  NODE_AUTH_TOKEN: ${{ secrets.MIDNIGHTBOT_PACKAGES_WRITE }}

on:
  push:
    branches:
      - main
    paths:
      - 'typescript/packages/dapp-connector-api/**'
  workflow_dispatch:

jobs:
  docs:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version-file: '.tool-versions'
          cache: 'yarn'
          cache-dependency-path: 'typescript/yarn.lock'

      - name: Run yarn install
        run: |
          cd typescript
          yarn workspace @midnight/wallet-e2e-tests remove @midnight-ntwrk/wallet_built
          yarn

      - name: Generate documentation
        run: |
          cd typescript
          yarn run build:docs

      - name: Check if there are changes in docs and create a new branch
        id: set_update
        run: |
          if git diff-index HEAD -- typescript/packages/dapp-connector-api/; then
            echo "Adding new..."
            git config --global user.email "midnight-ci@users.noreply.github.com"
            git config --global user.name "Midnight CI GitHub Action"
            BRANCH=api-docs/merge-prs/`date +'%Y-%m-%dT%H%M%S'`
            git checkout -b $BRANCH
            git push -u origin $BRANCH
            echo "UPDATE=true" >> $GITHUB_OUTPUT
            echo "NEW_BRANCH=$BRANCH" >> $GITHUB_OUTPUT
          else
            echo "Nothing to update"
            echo "UPDATE=false" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}

      - uses: MonikaJassova/ghcommit-action@aee0efc02d3707e178c534477e5c87f70fe6678f
        if: steps.set_update.outputs.UPDATE == 'true'
        with:
          commit_message: "DApp Connector API documentation update - created by Midnight CI Github Action"
          repo: ${{ github.repository }}
          branch: ${{ steps.set_update.outputs.NEW_BRANCH }}
          file_pattern: 'typescript/packages/dapp-connector-api/docs'
        env:
          GITHUB_TOKEN: ${{secrets.GH_TOKEN}}
      - name: Open a PR
        if: steps.set_update.outputs.UPDATE == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
        run: gh pr create --base main --head ${{ steps.set_update.outputs.NEW_BRANCH }} --title "API documentation update" --body "Update API documentation - created by Midnight CI Github Action"
