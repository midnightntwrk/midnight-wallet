name: CD

env:
  MIDNIGHT_GH_USER: ${{ secrets.GH_USERNAME }}
  MIDNIGHT_GH_TOKEN: ${{ secrets.MIDNIGHTCI_PACKAGES_WRITE }}
  MIDNIGHTCI_GPG_PRIVATE_KEY: ${{ secrets.MIDNIGHTCI_GPG_PRIVATE_KEY }}

on:
  workflow_dispatch:
  push:
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.ref_name }}
  cancel-in-progress: true

permissions: {}

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest-8-core-x64
    permissions:
      contents: write
      pull-requests: write
      packages: write

    concurrency:
      group: release-${{ github.ref_name }}
      cancel-in-progress: false

    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd #v6.0.2

      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 #v6.2.0
        with:
          node-version-file: '.nvmrc'
          cache: 'yarn'
          cache-dependency-path: 'yarn.lock'
          # This is required for the npm publish step
          token: ${{ env.MIDNIGHT_GH_TOKEN }}
          registry-url: 'https://npm.pkg.github.com'
          scope: '@midnight-ntwrk'

      - name: Enable corepack
        run: corepack enable

      - name: Configure yarn
        run: |
          yarn config set 'npmScopes.midnight-ntwrk.npmAuthToken' "${{ env.MIDNIGHT_GH_TOKEN }}"

      - name: Import GPG key
        id: gpg
        uses: crazy-max/ghaction-import-gpg@e89d40939c28e39f97cf32126055eeae86ba74ec #v6.3.0
        with:
          gpg_private_key: ${{ env.MIDNIGHTCI_GPG_PRIVATE_KEY }}
          git_user_signingkey: true
          git_commit_gpgsign: true

      - name: Configure GIT signing
        run: |
          git config user.name  "MidnightCI"
          git config user.email "midnight-automation+midnightci@iohk.io"
          git config user.signingkey "${{ steps.gpg.outputs.fingerprint }}"
          git config commit.gpgsign true
          git config tag.gpgSign true

      - name: Install dependencies
        run: |
          yarn install --immutable

      - name: Create Release Pull Request / Publish
        id: changesets
        uses: changesets/action@e0145edc7d9d8679003495b11f87bd8ef63c0cba #v1.5.3
        with:
          title: 'chore: release'
          version: yarn changeset:version
          publish: yarn changeset:publish
          setupGitUser: false

        env:
          GITHUB_TOKEN: ${{ env.MIDNIGHT_GH_TOKEN }}
          NODE_AUTH_TOKEN: ${{ env.MIDNIGHT_GH_TOKEN }}

  canary:
    name: Canary (snapshot publish)
    runs-on: ubuntu-latest-8-core-x64
    permissions:
      packages: write
      contents: read
    concurrency:
      group: canary-${{ github.ref_name }}
      cancel-in-progress: false

    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd #v6.0.2

      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 #v6.2.0
        with:
          node-version-file: '.nvmrc'
          cache: 'yarn'
          cache-dependency-path: 'yarn.lock'
          token: ${{ env.MIDNIGHT_GH_TOKEN }}
          registry-url: 'https://npm.pkg.github.com'
          scope: '@midnight-ntwrk'

      - name: Enable corepack
        run: corepack enable

      - name: Configure yarn
        run: |
          yarn config set 'npmScopes.midnight-ntwrk.npmAuthToken' "${{ env.MIDNIGHT_GH_TOKEN }}"

      - name: Install dependencies
        run: yarn install --immutable

      - name: Snapshot version + publish canary
        env:
          NODE_AUTH_TOKEN: ${{ env.MIDNIGHT_GH_TOKEN }}
          GITHUB_TOKEN: ${{ env.MIDNIGHT_GH_TOKEN }}
        run: |
          set -euo pipefail

          # Only exit pre-mode if actually in pre mode (not already exited)
          if grep -q '"mode": "pre"' .changeset/pre.json 2>/dev/null; then
            yarn changeset pre exit
          fi

          # Generate snapshot suffix
          SHORT_SHA=$(git rev-parse --short=7 HEAD)
          TIMESTAMP=$(date +%Y%m%d%H%M%S)

          # Apply snapshot versions
          yarn changeset version --snapshot canary.${TIMESTAMP}-${SHORT_SHA}

          # Install dependencies with the new snapshot versions
          yarn install --mode=update-lockfile

          # Build AFTER snapshot versions are applied
          yarn dist:publish

          # Publish under dist-tag "canary"
          yarn changeset publish --tag canary

      - name: Cleanup (always)
        if: always()
        run: |
          git reset --hard
          git clean -fd
