name: CD

env:
  MIDNIGHT_GH_USER: ${{ secrets.GH_USERNAME }}
  MIDNIGHT_GH_TOKEN: ${{ secrets.MIDNIGHTCI_PACKAGES_WRITE }}
  MIDNIGHTCI_GPG_PRIVATE_KEY: ${{ secrets.MIDNIGHTCI_GPG_PRIVATE_KEY }}
  VERDACCIO_TOKEN: ${{ secrets.VERDACCIO_AUTH_TOKEN }}
  VERDACCIO_URL: ${{ secrets.VERDACCIO_URL }}

on:
  workflow_dispatch:
  push:
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.ref_name }}
  cancel-in-progress: true

permissions: {}

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      packages: write

    concurrency:
      group: release-${{ github.ref_name }}
      cancel-in-progress: false

    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 #v6.0.1

      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 #v6.2.0
        with:
          node-version-file: '.nvmrc'
          cache: 'yarn'
          cache-dependency-path: 'yarn.lock'
          # This is required for the npm publish step
          registry-url: ${{ env.VERDACCIO_URL }}
          scope: '@midnight-ntwrk'

      - name: Enable corepack
        run: corepack enable

      - name: Configure yarn
        run: |
          yarn config set 'npmScopes.midnight-ntwrk.npmRegistryServer' "${{ env.VERDACCIO_URL }}"
          yarn config set 'npmScopes.midnight-ntwrk.npmAuthToken' "${{ env.VERDACCIO_TOKEN }}"

          # Fallback registry
          yarn config set npmRegistryServer "${{ env.VERDACCIO_URL }}"
          yarn config set npmAuthToken "${{ env.VERDACCIO_TOKEN }}"

      - name: Import GPG key
        id: gpg
        uses: crazy-max/ghaction-import-gpg@e89d40939c28e39f97cf32126055eeae86ba74ec #v6.3.0
        with:
          gpg_private_key: ${{ env.MIDNIGHTCI_GPG_PRIVATE_KEY }}
          git_user_signingkey: true
          git_commit_gpgsign: true

      - name: Configure GIT signing
        run: |
          git config user.name  "MidnightCI"
          git config user.email "midnight-automation+midnightci@iohk.io"
          git config user.signingkey "${{ steps.gpg.outputs.fingerprint }}"
          git config commit.gpgsign true
          git config tag.gpgSign true

      - name: Install dependencies
        run: |
          yarn install --immutable

      - name: Create Release Pull Request / Publish
        id: changesets
        uses: changesets/action@e0145edc7d9d8679003495b11f87bd8ef63c0cba #v1.5.3
        with:
          title: 'chore: release'
          version: yarn changeset:version
          publish: yarn changeset:publish
          setupGitUser: false

        env:
          GITHUB_TOKEN: ${{ env.MIDNIGHT_GH_TOKEN }}
          NODE_AUTH_TOKEN: ${{ env.VERDACCIO_TOKEN }}

  canary:
    name: Canary (snapshot publish)
    runs-on: ubuntu-latest
    permissions:
      packages: write
      contents: read
    concurrency:
      group: canary-${{ github.ref_name }}
      cancel-in-progress: false

    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 #v6.0.1

      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 #v6.2.0
        with:
          node-version-file: '.nvmrc'
          cache: 'yarn'
          cache-dependency-path: 'yarn.lock'
          registry-url: ${{ env.VERDACCIO_URL }}
          scope: '@midnight-ntwrk'

      - name: Enable corepack
        run: corepack enable

      - name: Configure yarn
        run: |
          yarn config set 'npmScopes.midnight-ntwrk.npmRegistryServer' "${{ env.VERDACCIO_URL }}"
          yarn config set 'npmScopes.midnight-ntwrk.npmAuthToken' "${{ env.VERDACCIO_TOKEN }}"

          yarn config set npmRegistryServer "${{ env.VERDACCIO_URL }}"
          yarn config set npmAuthToken "${{ env.VERDACCIO_TOKEN }}"

      - name: Install dependencies
        run: yarn install --immutable

      - name: Snapshot version + publish canary
        env:
          NODE_AUTH_TOKEN: ${{ env.VERDACCIO_TOKEN }}
          GITHUB_TOKEN: ${{ env.MIDNIGHT_GH_TOKEN }}
        run: |
          set -euo pipefail

          # Temporarily exit pre-mode so snapshots are allowed
          yarn changeset pre exit

          # Apply snapshot versions
          yarn changeset version --snapshot canary

          # Install dependencies with the new snapshot versions
          yarn install --mode=update-lockfile

          # Build AFTER snapshot versions are applied
          yarn dist:publish

          # Publish under dist-tag "canary"
          yarn changeset publish --tag canary

      - name: Cleanup (always)
        if: always()
        run: |
          git reset --hard
          git clean -fd
