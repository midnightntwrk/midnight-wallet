name: E2E tests

env:
    MIDNIGHT_REPO_USER: ${{ secrets.MIDNIGHT_REPO_USER }}
    MIDNIGHT_REPO_PASS: ${{ secrets.MIDNIGHT_REPO_PASS }}
    MIDNIGHT_GH_USER: ${{ github.actor }}
    MIDNIGHT_GH_TOKEN: ${{ secrets.GH_TOKEN }}
    NEXUS_TOKEN: ${{ secrets.NEXUS_TOKEN }}
    MIDNIGHTBOT_PACKAGES_WRITE: ${{ secrets.MIDNIGHTBOT_PACKAGES_WRITE }}

on:
    workflow_dispatch:
    workflow_call:
        inputs:
            network:
                type: string
                description: Midnight network to use (devnet/undeployed)
                required: true
                default: 'devnet'
            deployment:
                type: string
                description: Midnight deployment to use (devnet/qanet/local)
                required: true
                default: 'devnet'
            seed:
                type: string
                description: Seed of a funded wallet
                required: true
            seed2:
                type: string
                description: Seed of another receiving wallet
                required: true
            modifier:
                type: string
                description: Suite or a testname to run (refer to Jest docs)
                required: false
        secrets:
            GH_TOKEN:
              required: true
            MIDNIGHT_REPO_USER:
              required: true
            MIDNIGHT_REPO_PASS:
              required: true
            GH_USERNAME:
              required: true
            MIDNIGHTBOT_PACKAGES_WRITE:
              required: true
            NEXUS_TOKEN:
              required: true
    

jobs:
    build:
        name: E2E tests
        runs-on: ubuntu-latest-4-cores
        steps:
            - name: Prepare .netrc to access other repos
              run: echo -e "machine github.com\nlogin git\npassword ${{ secrets.GH_TOKEN }}\n\nmachine api.github.com\nlogin git\npassword ${{ secrets.GH_TOKEN }}" > ~/.netrc && chmod 755 ~/.netrc

            - uses: actions/checkout@v3

            - uses: nixbuild/nix-quick-install-action@v25
              with:
                github_access_token: ${{ secrets.GH_TOKEN }}
                nix_conf: |
                    access-tokens = github.com=${{ secrets.GH_TOKEN }} api.github.com=${{ secrets.GH_TOKEN }}
                    extra-trusted-public-keys = hydra.iohk.io:f/Ea+s+dFdN+3Y/G+FDgSq+a5NEWhJGzdjvKNGv0/EQ=
                    extra-substituters = https://cache.iog.io
                    accept-flake-config = true
                    netrc-file = ~/.netrc

            - name: Restore and cache Nix store
              uses: nix-community/cache-nix-action@v4
              with:
                gc-linux: true
                gc-max-store-size-linux: 8000000000
                key: cache-ubuntu-${{ hashFiles('**/*') }}
                restore-keys: |
                    cache-ubuntu-

            - name: Setup .npmrc
              run: |
                    echo "
                    //nexus.p42.at/repository/npm-midnight/:_authToken=$NEXUS_TOKEN
                    //npm.pkg.github.com/:_authToken=$MIDNIGHTBOT_PACKAGES_WRITE
                    " >> ./.npmrc

            - name: Log in to GitHub Container registry
              uses: docker/login-action@65b78e6e13532edd9afa3aa52ac7964289d1a9c1
              with:
                registry: 'https://ghcr.io'
                username: ${{ secrets.GH_USERNAME }}
                password: ${{ secrets.MIDNIGHTBOT_PACKAGES_WRITE }}

            - name: Configure yarn
              run: |
                cd typescript
                yarn config set 'npmScopes.midnight.npmAuthToken' "$NEXUS_TOKEN"
                yarn config set 'npmScopes.midnight-ntwrk.npmAuthToken' "$MIDNIGHTBOT_PACKAGES_WRITE"
                echo 'enableImmutableInstalls: false' >> ./.yarnrc.yml
            
            - name: Test and build typescript packages
              env:
                NETWORK: ${{ inputs.network }}
                DEPLOYMENT: ${{ inputs.deployment }}
                SEED: ${{ inputs.seed }}
                SEED2: ${{ inputs.seed2 }}
              run: |
                nix develop .#typescript --command yarn
                nix develop .#typescript --command yarn test-e2e -- ${{inputs.modifier}}

            - name: Publish wallet TS Test Report
              uses: dorny/test-reporter@v1
              if: success() || failure()
              with:
                name: Wallet TS packages Jest Tests Report
                reporter: jest-junit
                path: |
                    ./typescript/packages/e2e-tests/reports/report.xml

            - name: Publish Wallet TS Test Summary
              uses: EnricoMi/publish-unit-test-result-action@v2
              if: success() || failure()
              with:
                check_name: Wallet TS Packages Jest Tests Results
                files: |
                    ./typescript/packages/e2e-tests/reports/report.xml
